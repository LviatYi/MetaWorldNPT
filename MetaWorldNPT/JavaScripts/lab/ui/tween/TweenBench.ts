import Waterween from "../../../depend/waterween/Waterween";
import Log4Ts from "../../../depend/log4ts/Log4Ts";
import BoardPanel from "../BoardPanel";
import TweenElementPanel from "./TweenElementPanel";
import TweenElementPanelOld from "./TweenElementPanelOld";

@Component
export default class TweenBench extends mw.Script {
//#region Member
    private _eventListeners: EventListener[] = [];

    private _useWaterween: boolean = false;

    private _avg: number = 0;
    private _sampleCount: number = 0;

    private _startTime: number = null;
//#endregion ⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠐⠒⠒⠒⠒⠚⠛⣿⡟⠄⠄⢠⠄⠄⠄⡄⠄⠄⣠⡶⠶⣶⠶⠶⠂⣠⣶⣶⠂⠄⣸⡿⠄⠄⢀⣿⠇⠄⣰⡿⣠⡾⠋⠄⣼⡟⠄⣠⡾⠋⣾⠏⠄⢰⣿⠁⠄⠄⣾⡏⠄⠠⠿⠿⠋⠠⠶⠶⠿⠶⠾⠋⠄⠽⠟⠄⠄⠄⠃⠄⠄⣼⣿⣤⡤⠤⠤⠤⠤⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄

//#region MetaWorld Event
    protected onStart(): void {
        super.onStart();
        this.useUpdate = true;
//#region Member init
//#endregion ------------------------------------------------------------------------------------------

//#region Widget bind
//#endregion ------------------------------------------------------------------------------------------

//#region Event Subscribe
        // this._eventListeners.push(Event.addLocalListener(EventDefine.EVENT_NAME, CALLBACK));
//#endregion ------------------------------------------------------------------------------------------
    }

    protected onUpdate(dt: number): void {
        super.onUpdate(dt);
        let startTime = Date.now();
        if (startTime === null || startTime < this._startTime + 2e3) return;
        if (this._useWaterween) {
            Waterween.update();
        } else {
            actions.AcitonMgr.update(dt * 1000);
        }
        const cost = Date.now() - startTime;
        if (this._sampleCount > 10) {
            this._avg = (this._avg * (this._sampleCount - 10) + cost) / (this._sampleCount - 9);
        }
        ++this._sampleCount;
        Log4Ts.log(TweenBench, `all actions task done.`,
            `now use ${this._useWaterween ? "Waterween" : "Actions"}`,
            `cost time avg: ${this._avg}`,
            `sample count: ${this._sampleCount}`);
    }

    protected onDestroy(): void {
        super.onDestroy();

//#region Event Unsubscribe
        this._eventListeners.forEach(value => value.disconnect());
//#endregion ------------------------------------------------------------------------------------------
    }

//#endregion

//#region Init
    public init(useWaterween: boolean): void {
        this._useWaterween = useWaterween;
        this._startTime = Date.now();

        if (SystemUtil.isClient()) {
            const now = Date.now();
            const testCount = 2400;
            // const testCount = 5;
            for (let i = 0; i < testCount; ++i) {
                if (this._useWaterween) {
                    UIService.getUI(BoardPanel).addToMain(UIService.create(TweenElementPanel).uiObject);
                } else {
                    UIService.getUI(BoardPanel).addToMain(UIService.create(TweenElementPanelOld).uiObject);
                }
            }
            Log4Ts.log(TweenBench, `create ${testCount} task done.`,
                `now use ${this._useWaterween ? "Waterween" : "Actions"}`,
                `cost time: ${Date.now() - now}`,
            );
        }
    }

//#endregion ⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠐⠒⠒⠒⠒⠚⠛⣿⡟⠄⠄⢠⠄⠄⠄⡄⠄⠄⣠⡶⠶⣶⠶⠶⠂⣠⣶⣶⠂⠄⣸⡿⠄⠄⢀⣿⠇⠄⣰⡿⣠⡾⠋⠄⣼⡟⠄⣠⡾⠋⣾⠏⠄⢰⣿⠁⠄⠄⣾⡏⠄⠠⠿⠿⠋⠠⠶⠶⠿⠶⠾⠋⠄⠽⠟⠄⠄⠄⠃⠄⠄⣼⣿⣤⡤⠤⠤⠤⠤⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄

//#region Member
//#endregion ⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠐⠒⠒⠒⠒⠚⠛⣿⡟⠄⠄⢠⠄⠄⠄⡄⠄⠄⣠⡶⠶⣶⠶⠶⠂⣠⣶⣶⠂⠄⣸⡿⠄⠄⢀⣿⠇⠄⣰⡿⣠⡾⠋⠄⣼⡟⠄⣠⡾⠋⣾⠏⠄⢰⣿⠁⠄⠄⣾⡏⠄⠠⠿⠿⠋⠠⠶⠶⠿⠶⠾⠋⠄⠽⠟⠄⠄⠄⠃⠄⠄⣼⣿⣤⡤⠤⠤⠤⠤⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄

//#region Event Callback
//#endregion ⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠐⠒⠒⠒⠒⠚⠛⣿⡟⠄⠄⢠⠄⠄⠄⡄⠄⠄⣠⡶⠶⣶⠶⠶⠂⣠⣶⣶⠂⠄⣸⡿⠄⠄⢀⣿⠇⠄⣰⡿⣠⡾⠋⠄⣼⡟⠄⣠⡾⠋⣾⠏⠄⢰⣿⠁⠄⠄⣾⡏⠄⠠⠿⠿⠋⠠⠶⠶⠿⠶⠾⠋⠄⠽⠟⠄⠄⠄⠃⠄⠄⣼⣿⣤⡤⠤⠤⠤⠤⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄
}
